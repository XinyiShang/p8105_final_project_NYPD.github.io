---
title: "EDA_social"
author: "Siqing Wang"
date: "2023-12-05"
output: 
  html_document:
    keep_md: yes
  github_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message=FALSE,
  warning=FALSE)
library(tidyverse)
library(dplyr)
library(sf)
library(tmap)
library(leaflet)
library(leafgl)
```


```{r,include=FALSE}
# Import and clead NYPD data
# df_nypd = read_csv("https://www.dropbox.com/scl/fi/kf2zk4t1onxzm2vo3lpkq/NYPD_Complaint_Data_Historic.csv?rlkey=ly36vi9v66sno80eir6rohlwn&dl=1", na = "(null)") |> # some values are coded as "(null)" in the df; rewrite them as NA
#   janitor::clean_names() 

## Siqing' note: I'm currently reading from my local file. Yuki, when you run this file please comment out the chunk below and use the dropbox. Thanks!!

# df_nypd = read_csv("../NYPD_Complaint_Data_Historic.csv") |> 
#   janitor::clean_names()

df_nypd = read_csv("https://www.dropbox.com/scl/fi/1j6emjrdo3zbjrt5ehgq0/NYPD_Complaint_Data_Historic.csv?rlkey=co02d6vsgxr0aj44r7uhnbz64&dl=1", na = "(null)") |> 
  janitor::clean_names() 


prec_neighbor = read_csv("data/nyc_prec_neighborhood.csv")

#Merging neighborhood information with NYPD data, keep only relevant variables
nypd_ses_df = df_nypd |> 
  select(cmplnt_num, cmplnt_fr_dt, addr_pct_cd, crm_atpt_cptd_cd, law_cat_cd, susp_age_group, susp_race, susp_sex, vic_age_group, vic_race, vic_sex, ofns_desc, pd_desc, latitude, longitude) |> 
  rename(precinct = addr_pct_cd) |> 
  mutate(cmplnt_fr_dt = as.Date(cmplnt_fr_dt, format = "%m/%d/%Y"),
         year = format(cmplnt_fr_dt, "%Y")) |> 
  left_join(prec_neighbor, by = "precinct") |> 
  drop_na(neighborhood) # drop values missing neighborhood info 
```


```{r}
#Import and clean socio-economic data. neighbor_SES has SES indicators (except rent) for each neighborhood 
neighbor_ses = readxl::read_excel("data/neighorhood_indicators.xlsx", sheet = "Data") |> 
  janitor::clean_names() |> 
  filter(region_type == "Sub-Borough Area") |> 
  rename(neighborhood = region_name) |> 
  select(neighborhood, year, pop_num, hh_inc_med_adj, pop16_unemp_pct, pop_edu_collp_pct, pop_edu_nohs_pct, pop_pov_pct, pop_race_asian_pct, pop_race_black_pct, pop_race_hisp_pct, pop_race_white_pct, pop_foreign_pct) |> 
  filter(year %in% c(2017, 2018, 2019, 2020, 2021, 2022))

#neighbor_rent has rent data for each neighborhood 
neighbor_rent = readxl::read_excel("data/neighorhood_indicators.xlsx", sheet = "Data") |> 
  janitor::clean_names() |> 
  filter(region_type == "Sub-Borough Area") |> 
  rename(neighborhood = region_name) |> 
  filter(year == "2017-2021") |> 
  select(neighborhood, gross_rent_0_1beds, gross_rent_2_3beds)
```

```{r}
#ses_df has crime rate and SES indicators for each neighborhood
ses_df = nypd_ses_df |> 
  group_by(year, borough, neighborhood) |> 
  summarise(crime_num = n())

ses_df = ses_df |> merge(neighbor_ses, by = c("year", "neighborhood")) |> 
  mutate(crime_rate = (crime_num/pop_num) * 100,000) |> 
  left_join(neighbor_rent, by = "neighborhood")
```

## Heatmap

```{r}
# NYC neighborhoods borders
nyc = read_sf(here::here("data", "NTA_map.geojson")) |> 
  select(-shape_area, -shape_leng, -ntacode)

# 
nypd_ses_df_heat = nypd_ses_df |>  
    st_as_sf(
        # which columns to use as coordinates
        coords=c('longitude', 'latitude'), 
        # keep the coordinate columns
        remove=FALSE,
        # projection system
        crs=4326
    ) |> 
  select(cmplnt_num, law_cat_cd, latitude, longitude) |> 
  filter(law_cat_cd == "VIOLATION") 

nyc |> select(geometry) |> plot()
nypd_ses_df_heat |> select(geometry) |> plot(col='blue', add=TRUE)

# ggplot
ggplot(nypd_ses_df_heat) + 
  geom_sf(data = nyc) + 
  geom_sf() +
  coord_sf()

# spatial join
felony_in_neighborhoods = nypd_ses_df_heat |> 
    # only care about the felony and geometry
    select(cmplnt_num, geometry) |> 
    # spatial join
    st_join(
        # only need these columns from neighborhood tibble
        nyc |> select(boroname, ntaname, geometry),
        # join rows where there is some over lap between
        # a dock and a neighborhod
        join = st_intersects,
        # keep only docks that are in a neighborhood
        # this will ignore Jersey City
        left = FALSE
    )

count_by_neighborhood = felony_in_neighborhoods |> 
  # remove geometry for fast counting
  st_drop_geometry() |> 
  count(ntaname) |> 
  # join the counts into the nyc neighborhood object
  right_join(nyc, by=c('ntaname'='ntaname')) |> 
  st_as_sf() |> 
  select(ntaname, n, boroname, geometry)

ggplot(count_by_neighborhood, aes(fill = n)) +
  geom_sf() +
  coord_sf() +
  theme_bw()

# tmap
tm_shape(nypd_ses_df_heat) +
  tm_dots()

tm_shape(nyc) +
  tm_polygons() +
  tm_shape(nypd_ses_df_heat) +
  tm_dots()

tm_shape(count_by_neighborhood) +
  tm_polygons(col = "n")

# leaflet
leaflet(elementId = "nypd_ses_df_heat") |> 
  addTiles() |> 
  addCircles(data = nypd_ses_df_heat)

dock_palette = colorQuantile(palette = "Dark2", domain = count_by_neighborhood$n, 
                              na.color = "transparant")

leaflet(elementId='DocksHoodsCountZoomed') |> addTiles() |> 
    addPolygons(data=count_by_neighborhood, opacity=1, color='black',
                fillColor=~dock_palette(n), stroke=TRUE, weight=.5) |> 
    setView(lng=-73.85, lat=40.75, zoom=11)
```

## Crime type

### What are the top 5 neighborhoods with highest average crime rate?
```{r}
ses_df |> group_by(borough, neighborhood) |>
  summarise(avg_crime_rate = mean(crime_rate, na.rm = TRUE)) |> 
  arrange(desc(avg_crime_rate)) |> head(5) |> knitr::kable()
```

### What are the top 5 neighborhoods with highest average crime rate?

```{r}
ses_df |> group_by(borough, neighborhood) |>
  summarise(avg_crime_rate = mean(crime_rate, na.rm = TRUE)) |> 
  arrange(desc(avg_crime_rate)) |> tail(5) |> knitr::kable()
```

Since CUMC is located in Manhattan, let's visualize the crime rate in Manhattan: 

```{r}
ses_df |> group_by(borough, neighborhood) |>
  filter(borough == "Manhattan") |> 
  summarise(avg_crime_rate = mean(crime_rate, na.rm = TRUE)) |> 
  arrange(desc(avg_crime_rate)) |> knitr::kable()
```

The top 5 neighborhoods of highest average crime rate are to our surprise, so we further looked into the common types of crimes in these neighorhoods. 

### What are the most common types of crime in these neighborhoods?

Chelsea/Clinton/Midtown:
```{r}
nypd_ses_df |> 
  filter(neighborhood =="Chelsea/Clinton/Midtown") |> 
  count(ofns_desc) |> 
  arrange(desc(n)) |> 
  head(5) |> 
  mutate(percentage = scales::percent(n / sum(n), scale = 100)) |> 
  select(ofns_desc, percentage) |> 
  rename(crime_type = ofns_desc) |> 
  knitr::kable()
```

University Heights/Fordham: 
```{r}
nypd_ses_df |> 
  filter(neighborhood == "University Heights/Fordham") |> 
  count(ofns_desc) |> 
  arrange(desc(n)) |> 
  head(5) |> 
  mutate(percentage = scales::percent(n / sum(n), scale = 100)) |> 
  select(ofns_desc, percentage) |> 
  rename(crime_type = ofns_desc) |>
  knitr::kable() 
```

Mott Haven/Hunts Point: 
```{r}
nypd_ses_df |> 
  filter(neighborhood == "Mott Haven/Hunts Point") |> 
  count(ofns_desc) |> 
  arrange(desc(n)) |> 
  head(5) |> 
  mutate(percentage = scales::percent(n / sum(n), scale = 100)) |> 
  select(ofns_desc, percentage) |> 
  rename(crime_type = ofns_desc) |>
  knitr::kable() 
```

East Harlem:
```{r}
nypd_ses_df |> 
  filter(neighborhood == "East Harlem") |> 
  count(ofns_desc) |> 
  arrange(desc(n)) |> 
  head(5) |> 
  mutate(percentage = scales::percent(n / sum(n), scale = 100)) |> 
  select(ofns_desc, percentage) |> 
  rename(crime_type = ofns_desc) |>
  knitr::kable() 
```

Lower East Side/Chinatown: 
```{r}
nypd_ses_df |> 
  filter(neighborhood == "Lower East Side/Chinatown") |> 
  count(ofns_desc) |> 
  arrange(desc(n)) |> 
  head(5) |> 
  mutate(percentage = scales::percent(n / sum(n), scale = 100)) |> 
  select(ofns_desc, percentage) |>
  rename(crime_type = ofns_desc) |>
  knitr::kable() 
```

The high crime rate in Chelsea/Clinton/Midtown can be explained by the significant contribution of petite and grand larceny, which is as expected. 

Since CUMC is located in Washington Heights, let's take a closer look at the top 10 crime types at Washington Heights: 

```{r}
nypd_ses_df |> 
  filter(neighborhood == "Washington Heights/Inwood") |> 
  count(ofns_desc) |> 
  arrange(desc(n)) |> 
  head(10) |> 
  mutate(percentage = n / sum(n) * 100) |>
  ggplot(aes(x = reorder(ofns_desc, -percentage), y = percentage)) + 
  geom_bar(stat = "identity") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8)) + 
   labs(title = "Top 10 types of crime in Washington Heights/Inwood",
       x = "Percentage of all crimes",
       y = "Type of crimes") 
```


## Line plot

### Is there an association between rent and crime rate?

```{r}
ses_df |> group_by(neighborhood) |> 
  summarise(avg_rent_0_1beds = mean(gross_rent_0_1beds), 
            avg_rent_2_3beds = mean(gross_rent_2_3beds)
            , avg_crime_rate = mean(crime_rate, na.rm = TRUE)) |> 
  ggplot(aes(x = avg_crime_rate)) +
  geom_point(aes(y = avg_rent_0_1beds, color = "Average Rent 0-1 Beds")) +
  geom_point(aes(y = avg_rent_2_3beds, color = "Average Rent 2-3 Beds")) +
  geom_smooth(aes(y = avg_rent_0_1beds), method = "lm", se = TRUE, color = "red") +
  geom_smooth(aes(y = avg_rent_2_3beds), method = "lm", se = TRUE, color = "blue") +
  scale_color_manual(values = c("Average Rent 0-1 Beds" = "red", "Average Rent 2-3 Beds" = "blue")) +
  labs(title = "Point Plot of average rent against average crime rate",
       x = "Crime rate",
       y = "Average rent ($)") 
```

There appears to be no obvious association between rent and crime rate.  



